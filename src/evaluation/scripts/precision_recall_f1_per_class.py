import numpy as np
import matplotlib.pyplot as plt
from sklearn.metrics import precision_score, recall_score


def plot_prec_recall_f1_p_class(output_dir, figure_dir):
    '''
    Computes and ciusalizes Precision, Recall and F1-score for each emotion class.
    This function expects inference outputs generated by inference.py stored in output_dir.
    '''

    plt.rcParams.update({
    "text.usetex": True,
    "font.family": "serif",
    "font.serif": ["Times"],
    "font.size": 8,
    "axes.labelsize": 8,
    "axes.titlesize": 8,
    "legend.fontsize": 7,
    "xtick.labelsize": 7,
    "ytick.labelsize": 7,
    })


    # Load inference results
    y_true = np.load(output_dir / "y_true.npy")
    y_pred = np.load(output_dir / "y_pred.npy")
    class_names = np.load(output_dir / "class_names.npy", allow_pickle=True)

    # Compute per-class precision and recall
    precision = precision_score(y_true, y_pred, labels=range(len(class_names)), average=None)
    recall = recall_score(y_true, y_pred, labels=range(len(class_names)), average=None)

    # Manual F1 computation for transperency
    f1 = 2 * (precision * recall) / (precision + recall + 1e-8)

    # Prepare chart diagram
    x = np.arange(len(class_names))
    fig, ax = plt.subplots()
  
    width = 0.25
    bars1 = ax.bar(x - width, precision, width, label='Precision')
    bars2 = ax.bar(x, recall, width, label='Recall')
    bars3 = ax.bar(x + width, f1, width, label='F1 Score')
    
    # Plot chart diagram
    ax.set_ylabel('Score')
    ax.set_title('Precision, Recall & F1 per class')
    ax.set_xticks(x)
    ax.set_xticklabels(class_names)
    ax.set_ylim(0, 1)
    ax.legend()
    
    # Annotate bars with numeric values
    for bars in [bars1, bars2, bars3]:
        for bar in bars:
            ax.annotate(f'{bar.get_height():.2f}',
                        xy=(bar.get_x() + bar.get_width() / 2, bar.get_height()),
                        xytext=(0, 3), textcoords="offset points",
                        ha='center', va='bottom', fontsize=6)

    # Save diagram
    plt.savefig(figure_dir / "prec_recall_f1_per_class.png", dpi=300)