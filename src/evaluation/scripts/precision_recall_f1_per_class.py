import numpy as np
import matplotlib as mpl
import matplotlib.pyplot as plt
from sklearn.metrics import precision_score, recall_score

# Define a consistent plotting style for all epoch curves to Match the Latex requirements
PLOT_STYLE = {
    "font.family": "serif",
    "font.serif": ["Times"],
    "mathtext.fontset": "stix",
    "font.size": 9,
    "axes.labelsize": 9,
    "axes.titlesize": 9,
    "legend.fontsize": 8,
    "xtick.labelsize": 8,
    "ytick.labelsize": 8,
    "axes.linewidth": 1.0,
}


def plot_prec_recall_f1_p_class(output_dir, figure_dir):
    """
    Computes and ciusalizes Precision, Recall and F1-score for each emotion class.
    This function expects inference outputs generated by inference.py stored in output_dir.
    """

    with mpl.rc_context(PLOT_STYLE):

        # Load inference results
        y_true = np.load(output_dir / "y_true.npy")
        y_pred = np.load(output_dir / "y_pred.npy")
        class_names = np.load(output_dir / "class_names.npy", allow_pickle=True)

        # Compute per-class precision and recall
        precision = precision_score(
            y_true, y_pred, labels=range(len(class_names)), average=None
        )
        recall = recall_score(y_true, y_pred, labels=range(len(class_names)), average=None)

        # Manual F1 computation for transperency
        f1 = 2 * (precision * recall) / (precision + recall + 1e-8)

        # Prepare chart diagram
        x = np.arange(len(class_names))
        
        fig, ax = plt.subplots(figsize=(3.4, 2.6))
        width = 0.25
        
        bars1 = ax.bar(x - width, precision, width, label="Precision")
        bars2 = ax.bar(x, recall, width, label="Recall")
        bars3 = ax.bar(x + width, f1, width, label="F1 Score")

        # Plot chart diagram
        ax.set_ylabel("Score")
        ax.set_xticks(x)
        ax.set_xticklabels(class_names, rotation=45, ha="right")
        ax.set_ylim(0, 1)
        ax.legend()

        # Annotate bars with numeric values
        for bars in [bars1, bars2, bars3]:
            for bar in bars:
                ax.annotate(
                    f"{bar.get_height():.2f}",
                    xy=(bar.get_x() + bar.get_width() / 2, bar.get_height()),
                    xytext=(0, 3),
                    textcoords="offset points",
                    ha="center",
                    va="bottom",
                    fontsize=7,
                )

        # Save as vector graphic
        plt.savefig(
            figure_dir / "prec_recall_f1_per_class.pdf", format="pdf", bbox_inches="tight"
        )

        plt.close(fig)
